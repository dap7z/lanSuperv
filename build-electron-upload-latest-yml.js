#!/usr/bin/env node
/**
 * Script to upload latest.yml to GitHub release
 * This is needed because electron-builder doesn't automatically publish files generated by hooks
 */

const fs = require('fs');
const path = require('path');
const https = require('https');

const outputDir = path.join(__dirname, 'dist-electron');
const latestYmlPath = path.join(outputDir, 'latest.yml');
const packageJson = require('./package.json');
const version = packageJson.version;

// Get GitHub token from environment
const ghToken = process.env.GH_TOKEN || process.env.GITHUB_TOKEN;

if (!ghToken) {
  console.error('‚ùå Error: GH_TOKEN or GITHUB_TOKEN environment variable is not set');
  process.exit(1);
}

if (!fs.existsSync(latestYmlPath)) {
  console.error('‚ùå Error: latest.yml not found at: ' + latestYmlPath);
  process.exit(1);
}

const owner = 'dap7z';
const repo = 'lanSuperv';
const tag = `v${version}`;

console.log(`üì§ Uploading latest.yml to GitHub release ${tag}...`);

// Read the file
const fileContent = fs.readFileSync(latestYmlPath, 'utf8');
const fileSize = fs.statSync(latestYmlPath).size;

// Wait for release to be available (with retry)
function waitForRelease(maxAttempts = 10, delay = 6000) {
  return new Promise((resolve, reject) => {
    const url = `https://api.github.com/repos/${owner}/${repo}/releases/tags/${tag}`;
    let attempts = 0;
    
    function tryGetRelease() {
      attempts++;
      console.log(`‚è≥ Waiting for release to be available... (attempt ${attempts}/${maxAttempts})`);
      
      https.get(url, {
        headers: {
          'Authorization': `token ${ghToken}`,
          'User-Agent': 'lanSuperv-upload-script',
          'Accept': 'application/vnd.github.v3+json'
        }
      }, (res) => {
        let data = '';
        
        res.on('data', (chunk) => {
          data += chunk;
        });
        
        res.on('end', () => {
          if (res.statusCode === 200) {
            const release = JSON.parse(data);
            console.log(`‚úÖ Release found: ${release.name || tag}`);
            resolve(release);
          } else if (res.statusCode === 404 && attempts < maxAttempts) {
            // Release not found yet, wait and retry
            setTimeout(tryGetRelease, delay);
          } else {
            console.error(`‚ùå Error: Failed to get release: ${res.statusCode}`);
            console.error('Response:', data);
            reject(new Error(`Failed to get release after ${attempts} attempts: ${res.statusCode}`));
          }
        });
      }).on('error', (error) => {
        if (attempts < maxAttempts) {
          console.error(`‚ö†Ô∏è  Error getting release (attempt ${attempts}), retrying...`);
          setTimeout(tryGetRelease, delay);
        } else {
          console.error('‚ùå Error getting release:', error);
          reject(error);
        }
      });
    }
    
    tryGetRelease();
  });
}

// Main upload function
function uploadLatestYml(release) {
  const releaseId = release.id;
  
  // Upload the file
  const uploadUrl = `https://uploads.github.com/repos/${owner}/${repo}/releases/${releaseId}/assets?name=latest.yml`;
  
  const options = {
    method: 'POST',
    headers: {
      'Authorization': `token ${ghToken}`,
      'User-Agent': 'lanSuperv-upload-script',
      'Content-Type': 'application/x-yaml',
      'Content-Length': fileSize
    }
  };
  
  const req = https.request(uploadUrl, options, (uploadRes) => {
    let uploadData = '';
    
    uploadRes.on('data', (chunk) => {
      uploadData += chunk;
    });
    
    uploadRes.on('end', () => {
      if (uploadRes.statusCode === 201) {
        console.log('‚úÖ Successfully uploaded latest.yml to GitHub release');
      } else {
        // Check if file already exists (422 error)
        if (uploadRes.statusCode === 422) {
          console.log('‚ö†Ô∏è  latest.yml already exists in release, attempting to delete and re-upload...');
          // Delete existing asset and re-upload
          deleteAndReupload(releaseId, ghToken, fileContent, fileSize);
        } else {
          console.error(`‚ùå Error: Failed to upload latest.yml: ${uploadRes.statusCode}`);
          console.error('Response:', uploadData);
          process.exit(1);
        }
      }
    });
  });
  
  req.on('error', (error) => {
    console.error('‚ùå Error uploading file:', error);
    process.exit(1);
  });
  
  req.write(fileContent);
  req.end();
}

// Wait for release and then upload
waitForRelease()
  .then(uploadLatestYml)
  .catch((error) => {
    console.error('‚ùå Failed to upload latest.yml:', error.message);
    process.exit(1);
  });

function deleteAndReupload(releaseId, token, content, size) {
  // Get list of assets
  const assetsUrl = `https://api.github.com/repos/${owner}/${repo}/releases/${releaseId}/assets`;
  
  https.get(assetsUrl, {
    headers: {
      'Authorization': `token ${token}`,
      'User-Agent': 'lanSuperv-upload-script',
      'Accept': 'application/vnd.github.v3+json'
    }
  }, (res) => {
    let data = '';
    
    res.on('data', (chunk) => {
      data += chunk;
    });
    
    res.on('end', () => {
      if (res.statusCode !== 200) {
        console.error(`‚ùå Error: Failed to get assets: ${res.statusCode}`);
        process.exit(1);
      }
      
      const assets = JSON.parse(data);
      const latestYmlAsset = assets.find(a => a.name === 'latest.yml');
      
      if (latestYmlAsset) {
        // Delete existing asset
        const deleteUrl = `https://api.github.com/repos/${owner}/${repo}/releases/assets/${latestYmlAsset.id}`;
        
        const deleteReq = https.request(deleteUrl, {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${token}`,
            'User-Agent': 'lanSuperv-upload-script',
            'Accept': 'application/vnd.github.v3+json'
          }
        }, (deleteRes) => {
          if (deleteRes.statusCode === 204) {
            console.log('‚úÖ Deleted existing latest.yml');
            // Re-upload
            uploadFile(releaseId, token, content, size);
          } else {
            console.error(`‚ùå Error: Failed to delete existing latest.yml: ${deleteRes.statusCode}`);
            process.exit(1);
          }
        });
        
        deleteReq.on('error', (error) => {
          console.error('‚ùå Error deleting file:', error);
          process.exit(1);
        });
        
        deleteReq.end();
      } else {
        // File doesn't exist, just upload
        uploadFile(releaseId, token, content, size);
      }
    });
  }).on('error', (error) => {
    console.error('‚ùå Error getting assets:', error);
    process.exit(1);
  });
}

function uploadFile(releaseId, token, content, size) {
  const uploadUrl = `https://uploads.github.com/repos/${owner}/${repo}/releases/${releaseId}/assets?name=latest.yml`;
  
  const options = {
    method: 'POST',
    headers: {
      'Authorization': `token ${token}`,
      'User-Agent': 'lanSuperv-upload-script',
      'Content-Type': 'application/x-yaml',
      'Content-Length': size
    }
  };
  
  const req = https.request(uploadUrl, options, (res) => {
    let data = '';
    
    res.on('data', (chunk) => {
      data += chunk;
    });
    
    res.on('end', () => {
      if (res.statusCode === 201) {
        console.log('‚úÖ Successfully uploaded latest.yml to GitHub release');
      } else {
        console.error(`‚ùå Error: Failed to upload latest.yml: ${res.statusCode}`);
        console.error('Response:', data);
        process.exit(1);
      }
    });
  });
  
  req.on('error', (error) => {
    console.error('‚ùå Error uploading file:', error);
    process.exit(1);
  });
  
  req.write(content);
  req.end();
}
